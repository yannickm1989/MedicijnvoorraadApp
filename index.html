<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MedicijnVoorraad</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f7f9fc;
            margin: 0;
            padding: 20px;
        }

        h2 {
            color: #2a4d8f;
        }

        label {
            font-weight: bold;
        }

        input, button {
            padding: 10px;
            margin: 5px 0;
        }

        #medList div {
            padding: 6px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            color: #2a4d8f; /* blauwe tekst zoals jij wou */
        }

        .low-stock {
            color: red;
            font-weight: bold;
        }

        .expired {
            color: red;
            font-weight: bold;
        }

        .warning {
            background: #ffdddd;
            border: 1px solid red;
            padding: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <h2>Medicijn invoeren / aanpassen</h2>

    <label>Naam:</label><br>
    <input id="name" type="text"><br>

    <label>Voorraad:</label><br>
    <input id="stock" type="number"><br>

    <label>Houdbaarheidsdatum:</label><br>
    <input id="expiry" type="date"><br><br>

    <label>
        <input type="checkbox" id="daily"> Dagelijks innemen
    </label>
    <br><br>

    <button onclick="saveMed()">Opslaan</button>

    <h2>Voorraad</h2>
    <div id="warnings"></div>
    <div id="medList"></div>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_APP.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let editId = null;

        function saveMed() {
            const name = document.getElementById("name").value.trim();
            const stock = parseInt(document.getElementById("stock").value);
            const expiry = document.getElementById("expiry").value;
            const daily = document.getElementById("daily").checked;

            if (!name) return alert("Naam invullen!");

            const data = { name, stock, expiry, daily };

            if (editId) {
                db.collection("medicijnen").doc(editId).update(data);
                editId = null;
            } else {
                db.collection("medicijnen").add(data);
            }

            document.getElementById("name").value = "";
            document.getElementById("stock").value = "";
            document.getElementById("expiry").value = "";
            document.getElementById("daily").checked = false;
        }

        function loadMeds() {
            db.collection("medicijnen").orderBy("name").onSnapshot(snapshot => {
                const list = document.getElementById("medList");
                const warn = document.getElementById("warnings");

                list.innerHTML = "";
                warn.innerHTML = "";

                const today = new Date().toISOString().split("T")[0];

                snapshot.forEach(doc => {
                    const item = doc.data();

                    let className = "";
                    let showWarning = false;

                    if (item.stock <= 1) {
                        className = "low-stock";
                        showWarning = true;
                    }

                    if (item.expiry && item.expiry < today) {
                        className = "expired";
                        showWarning = true;
                    }

                    if (showWarning) {
                        warn.innerHTML += `<div class="warning">
                            ⚠ ${item.name} heeft een probleem (bijna op of vervallen)
                        </div>`;
                    }

                    const div = document.createElement("div");
                    div.className = className;
                    div.innerText = `${item.name} — ${item.stock} stuks`;

                    div.onclick = () => {
                        editId = doc.id;
                        document.getElementById("name").value = item.name;
                        document.getElementById("stock").value = item.stock;
                        document.getElementById("expiry").value = item.expiry ?? "";
                        document.getElementById("daily").checked = item.daily ?? false;
                    };

                    list.appendChild(div);
                });
            });
        }

        loadMeds();

        async function applyDailyUse() {
            const today = new Date().toISOString().split("T")[0];
            const docName = "lastDailyUse";

            const ref = db.collection("system").doc(docName);
            const data = await ref.get();

            let lastRun = data.exists ? data.data().date : null;

            if (lastRun === today) return; 

            const meds = await db.collection("medicijnen").get();
            meds.forEach(item => {
                const d = item.data();
                if (d.daily && d.stock > 0) {
                    db.collection("medicijnen").doc(item.id).update({
                        stock: d.stock - 1
                    });
                }
            });

            ref.set({ date: today });
        }

        setTimeout(applyDailyUse, 1000);
    </script>
</body>
</html>
